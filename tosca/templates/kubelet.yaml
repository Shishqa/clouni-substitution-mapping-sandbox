tosca_definitions_version: tosca_simple_yaml_1_3

imports:

- ../profiles/kubernetes/cluster.yaml

topology_template:

  inputs:

    component_version:
      type: version

    dns_ip:
      type: string

    pod_cidr:
      type: string

  node_templates:

    kubelet:
      type: kubetos.nodes.Kubernetes.Kubelet
      properties:
        component_version: { get_input: [ component_version ] }
      interfaces:
        Standard:
          inputs:
            kubelet_version: { concat: [ "v", { get_property: [ SELF, component_version ] } ] }
          operations:
            create:
              implementation:
                primary: ./ansible/kubelet--create.yaml
                dependencies:
                  - kubelet_role
                  - download_role
            configure:
              inputs:
                ip: { get_attribute: [ SELF, host, private_address ] }
                cri_socket: { get_property: [ SELF, cri_runtime, cri, url_path ] }
                kubelet_static_pod_path: { get_property: [ SELF, kubelet, static_pod_path ] }
                cert_path: { get_property: [ SELF, cert, cert_path ] }
                key_path: { get_property: [ SELF, cert, key_path ] }
                ca_cert_path: { get_property: [ SELF, ca, cert_path ] }
                kubeconfig_path: { get_property: [ SELF, kubeconfig, path ] }
                dns_ip: { get_property: [ SELF, dns_ip ] }
                pod_cidr: { get_property: [ SELF, pod_cidr ] }
              implementation:
                primary: ./ansible/kubelet--configure.yaml
                dependencies:
                  - kubelet_role
            start:
              implementation:
                primary: ./ansible/kubelet--start.yaml
                dependencies:
                  - kubelet_role
      artifacts:
        kubelet_role:
          file: ./ansible/roles/kubelet
          type: tosca.artifacts.File
          deploy_path: roles/kubelet
        download_role:
          file: utils/roles/download
          type: tosca.artifacts.File
          deploy_path: roles/download

  substitution_mappings:
    node_type: kubetos.nodes.Kubernetes.Kubelet
    capabilities:
      kubelet: [ kubelet, kubelet ]
    properties:
      component_version: [ component_version ]
      pod_cidr: [ pod_cidr ]
      dns_ip: [ dns_ip ]
    requirements:
      apiserver: [ kubelet, apiserver ]
      cri_runtime: [ kubelet, cri_runtime ]
      host: [ kubelet, host ]
