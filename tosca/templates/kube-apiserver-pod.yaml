tosca_definitions_version: tosca_simple_yaml_1_3

imports:

- ../profiles/cri/main.yaml

node_types:

  kubetos.nodes.Kubernetes.APIServer.StaticPod:
    derived_from: kubetos.nodes.Kubernetes.StaticPod
    capabilities:
      access_address:
        type: tosca.capabilities.Endpoint
    requirements:
      - etcd:
          capability: tosca.capabilities.Endpoint
          relationship: tosca.relationships.ConnectsTo
          occurrences: [ 1, UNBOUNDED ]

topology_template:

  inputs:

    kubernetes_version:
      type: version

    service_cidr:
      type: string

  node_templates:

    kube_apiserver_pod:
      type: kubetos.nodes.Kubernetes.APIServer.StaticPod
      requirements:
        - host: kubelet
      interfaces:
        Standard:
          inputs:
            ca_cert_path:
              value: { get_property: [ SELF, ca, cert_path ] }
              type: string
            cert_path:
              value: { get_property: [ SELF, cert, cert_path ] }
              type: string
            key_path:
              value: { get_property: [ SELF, cert, key_path ] }
              type: string
            sa_cert_path:
              value: { get_property: [ SELF, service_account_cert, cert_path ] }
              type: string
            sa_key_path:
              value: { get_property: [ SELF, service_account_cert, key_path ] }
              type: string
            kubelet_client_cert_path:
              value: { get_property: [ SELF, kubelet_client_cert, cert_path ] }
              type: string
            kubelet_client_key_path:
              value: { get_property: [ SELF, kubelet_client_cert, key_path ] }
              type: string
            etcd_peers:
              value: { get_attribute: [ SELF, etcd, peers ] }
              type: list
              entry_schema:
                type: kubetos.datatypes.Etcd.PeerSpec
            kube_version:
              value: { concat: [ "v", { get_property: [ SELF, component_version ] } ] }
              type: string
            private_address:
              value: { get_attribute: [ SELF, host, host, private_address ] }
              type: string
            public_address:
              value: { get_attribute: [ SELF, host, host, public_address ] }
              type: string
            static_pod_path:
              value: { get_property: [ SELF, kubelet, static_pod_path ] }
              type: string
            service_cidr:
              value: { get_property: [ SELF, service_cidr ] }
              type: string
            apiserver_count:
              value: 1
              type: integer
          operations:
            start:
              implementation:
                primary: ./ansible/kube-apiserver--start.yaml
                dependencies:
                  - ./ansible/files/kube-apiserver.yaml.j2

    kubelet:
      type: kubetos.nodes.Kubelet
      directives: [ substitute ]
      requirements:
        - apiserver: kube_apiserver_pod

  substitution_mappings:
    node_type: kubetos.nodes.Kubernetes.Root
    capabilities:
      access_address: [ kube_apiserver_pod, access_address ]
    properties:
      kubernetes_version: [ kubernetes_version ]
      service_cidr: [ service_cidr ]
    requirements:
      etcd: [ kube_apiserver_pod, etcd ]
      ca: [ kube_apiserver_pod, ca ]
      host: [ kubelet, host ]


      kubetos.nodes.Kubernetes.APIServer:
    derived_from: tosca.nodes.SoftwareComponent
    capabilities:
      access_address:
        type: tosca.capabilities.Endpoint
    properties:
      component_version:
        type: version
        default: 1.21.0
      service_cidr:
        type: string
    requirements:
      - etcd:
          capability: tosca.capabilities.Endpoint
          relationship: tosca.relationships.ConnectsTo
          occurrences: [ 1, UNBOUNDED ]
      - ca:
          capability: kubetos.capabilities.CertificateAuthority
          relationship: tosca.relationships.DependsOn
          occurrences: [ 1, 1 ]
      - kubelet_client_cert:
          capability: kubetos.capabilities.Certificate
          relationship: tosca.relationships.DependsOn
          occurrences: [ 1, 1 ]
      - tls_cert:
          capability: kubetos.capabilities.Certificate
          relationship: tosca.relationships.DependsOn
          occurrences: [ 1, 1 ]
