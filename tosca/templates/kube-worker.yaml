tosca_definitions_version: tosca_simple_yaml_1_3

metadata:
  template_name: "kubetos"
  template_author: "shishqa"
  template_version: "1.0"

imports:
  - ../profiles/cri/main.yaml
  - ../profiles/kubernetes/cluster.yaml

topology_template:

  inputs:

    kubelet_version:
      type: version

  node_templates:

    kubelet:
      type: kubetos.nodes.Kubernetes.Kubelet
      directives: [ substitute ]
      properties:
        component_version: { get_input: [ kubelet_version ] }
      requirements:
        - cri_runtime: cri
        - host: compute

    cri:
      type: kubetos.nodes.CRI
      directives: [ substitute ]
      requirements:
        - host: compute
        - cni: cni
        - oci_runtime: oci_runtime

    oci_runtime:
      type: kubetos.nodes.OCI.Runtime
      directives: [ substitute ]
      requirements:
        - host: compute

    cni:
      type: kubetos.nodes.CNI
      directives: [ substitute ]
      requirements:
        - host: compute

    etcd:
      type: kubetos.nodes.Etcd
      directives: [ substitute ]
      capabilities:
        access_address:
          properties:
            port: 2379
            api_version: v2
        peer_address:
          properties:
            port: 2380
      requirements:
        - host: compute

    compute:
      type: tosca.nodes.Compute
      directives: [ substitute ]

  substitution_mappings:
    node_type: kubetos.nodes.Kubernetes.Worker
    capabilities:
      kubelet: [ kubelet, kubelet ]
      scalable: [ compute, scalable ]
      endpoint: [ compute, endpoint ]
    properties:
      kubernetes_version: [ kubelet_version ]
    requirements:
      apiserver: [ kubelet, apiserver ]
