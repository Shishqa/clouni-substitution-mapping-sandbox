tosca_definitions_version: tosca_simple_yaml_1_3

imports:
- ../../profiles/ray/main.yaml


topology_template:
  inputs:
    additional_packages:
      type: list
      entry_schema:
        type: string

  node_templates:
    ray-slave:
      type: clouni.nodes.ray.slave
      properties:
        additional_packages: { get_input: [ additional_packages ] }
      interfaces:
        Standard:
          operations:
            create:
              inputs:
                additional_packages: { get_property: [ SELF, additional_packages ] }
                master_port: { get_property: [ SELF, master, port ] }
                master_address: { get_property: [ SELF, master, host, public_address ] }
                s3_endpoint_uri: { get_attribute: [ SELF, master, artifact-storage, access_uri ] }
                minio_key: { get_property: [ SELF, master, artifact-storage, access_token ] }
                minio_secret: { get_property: [ SELF, master, artifact-storage, access_password ] }
              implementation:
                primary: artifacts/ray/ansible/slave.yaml
                operation_host: HOST
                dependencies:
                  - artifacts/ray/ansible/roles/ray_slave_install
      artifacts:
        artifacts/ray/ansible/roles/ray_slave_install:
          file: artifacts/ray/ansible/roles/ray_slave_install
          type: tosca.artifacts.File
          deploy_path: roles/ray_slave_install

  substitution_mappings:
    node_type: clouni.nodes.ray.slave
    properties:
      additional_packages: [ additional_packages ]
    requirements:
      host: [ ray-slave, host ]
      master: [ ray-slave, master ]


