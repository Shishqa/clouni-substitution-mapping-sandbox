tosca_definitions_version: tosca_simple_yaml_1_3

imports:

- ../../profiles/etcd/main.yaml

topology_template:

  inputs:

    component_version:
      type: version

  node_templates:

    etcd:
      type: kubetos.nodes.Etcd
      capabilities:
        etcd:
          properties:
            name: etcd
      properties:
        component_version: { get_input: [ component_version ] }
      interfaces:
        Standard:
          operations:
            create:
              inputs:
                etcd_version: { concat: [ "v", { get_property: [ SELF, component_version ] } ] }
              implementation:
                primary: artifacts/etcd/ansible/etcd--create.yaml
                dependencies:
                  - artifacts/etcd/ansible/roles/etcd
                  - artifacts/utils/roles/download
                operation_host: HOST
            configure:
              inputs:
                etcd_version: { concat: [ "v", { get_property: [ SELF, component_version ] } ] }
                etcd_address: { get_attribute: [ SELF, peer_endpoint, ip_address ] }
                etcd_peer_port: { get_property: [ SELF, peer_endpoint, port ] }
                etcd_access_address: { get_attribute: [ SELF, access_endpoint, ip_address ] }
                etcd_access_port: { get_property: [ SELF, access_endpoint, port ] }
                etcd_member_name: { get_attribute: [ SELF, etcd, name ] }
                etcd_peers: { get_attribute: [ SELF, peers ] }
              implementation:
                primary: artifacts/etcd/ansible/etcd--configure.yaml
                dependencies:
                  - artifacts/etcd/ansible/roles/etcd
                operation_host: HOST
            start:
              inputs:
                etcd_version: { concat: [ "v", { get_property: [ SELF, component_version ] } ] }
              implementation:
                primary: artifacts/etcd/ansible/etcd--start.yaml
                dependencies:
                  - artifacts/etcd/ansible/roles/etcd
                operation_host: HOST
      artifacts:
        artifacts/etcd/ansible/roles/etcd:
          file: artifacts/etcd/ansible/roles/etcd
          type: tosca.artifacts.File
          deploy_path: roles/etcd
        artifacts/utils/roles/download:
          file: artifacts/utils/roles/download
          type: tosca.artifacts.File
          deploy_path: roles/download

  substitution_mappings:
    node_type: kubetos.nodes.Etcd
    capabilities:
      etcd: [ etcd, etcd ]
      peer_endpoint: [ etcd, peer_endpoint ]
      access_endpoint: [ etcd, access_endpoint ]
    properties:
      component_version: [ component_version ]
    requirements:
      host: [ etcd, host ]
