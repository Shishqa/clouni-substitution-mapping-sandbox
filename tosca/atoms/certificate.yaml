tosca_definitions_version: tosca_simple_yaml_1_3

imports:

- ../profiles/pki/main.yaml

topology_template:

  inputs:

    common_name:
      type: string
    organisation:
      type: string
    hostnames:
      type: list
      entry_schema:
        type: string
      default: []

  node_templates:

    certificate:
      type: kubetos.nodes.Certificate
      properties:
        common_name: { get_input: [ common_name ] }
        organisation: { get_input: [ organisation ] }
        hostnames: { get_input: [ hostnames ] }
      interfaces:
        Standard:
          operations:
            create:
              inputs:
                common_name:
                  value: { get_property: [ SELF, common_name ] }
                  type: string
                organisation:
                  value: { get_property: [ SELF, organisation ] }
                  type: string
                hostnames:
                  value: { get_property: [ SELF, hostnames ] }
                  type: list
                  entry_schema:
                    type: string
                ca_cert:
                  value: { get_attribute: [ SELF, ca, cert ] }
                  type: string
                ca_key:
                  value: { get_attribute: [ SELF, ca, key ] }
                  type: string
              outputs:
                cert: [ SELF, cert, data ]
                key: [ SELF, key, data ]
              implementation:
                primary: ./ansible/cert--create.yaml
                dependencies:
                  - ./ansible/files/csr.json.j2
                  - ./ansible/files/ca-config.json

  substitution_mappings:
    node_type: kubetos.nodes.Certificate
    capabilities:
      key: [ certificate, key ]
      cert: [ certificate, cert ]
    properties:
      common_name: [ certificate, common_name ]
      organisation: [ certificate, organisation ]
      hostnames: [ certificate, hostnames ]
    requirements:
      ca: [ certificate, ca ]
