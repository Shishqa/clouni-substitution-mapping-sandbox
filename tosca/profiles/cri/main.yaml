tosca_definitions_version: tosca_simple_yaml_1_3

imports:
  - ../cni/main.yaml

data_types:

  kubetos.datatypes.OCI.RuntimeSpec:
    derived_from: tosca.datatypes.Root
    properties:
      name:
        type: string
      path:
        type: string
      root:
        type: string

capability_types:

  kubetos.capabilities.OCI.Runtime:
    derived_from: tosca.capabilities.Node
    properties:
      spec:
        type: kubetos.datatypes.OCI.RuntimeSpec
        required: false

  kubetos.capabilities.CRI:
    derived_from: tosca.capabilities.Endpoint
    properties:
      protocol:
        type: string
        default: rpc
        constraints:
          - equal: rpc

relationship_types:

  kubetos.relationships.OCI.Plugin:
    derived_from: tosca.relationships.DependsOn
    # interfaces:
    #   Configure:
    #     type: tosca.interfaces.relationship.Configure
    #     operations:
    #       pre_configure_source:
    #         inputs:
    #           list:
    #             value: { get_attribute: [ SOURCE, runtimes ] }
    #             type: list
    #             entry_schema:
    #               type: kubetos.datatypes.OCI.RuntimeSpec
    #           new_item:
    #             value: { get_property: [ TARGET, oci, spec ] }
    #             type: kubetos.datatypes.OCI.RuntimeSpec
    #         outputs:
    #           new_list: [ SOURCE, runtimes ]
    #         implementation: ../../utils/add-to-list.yaml

node_types:

  kubetos.nodes.OCI.Runtime:
    derived_from: tosca.nodes.SoftwareComponent
    capabilities:
      oci: kubetos.capabilities.OCI.Runtime

  kubetos.nodes.Runc:
    derived_from: kubetos.nodes.OCI.Runtime
    properties:
      component_version:
        type: version
        default: 1.1.1

  kubetos.nodes.Kata:
    derived_from: kubetos.nodes.OCI.Runtime
    properties:
      component_version:
        type: version
        default: 2.1.0

  kubetos.nodes.CRI:
    derived_from: tosca.nodes.SoftwareComponent
    capabilities:
      cri: kubetos.capabilities.CRI
    attributes:
      runtimes:
        type: list
        entry_schema:
          type: kubetos.datatypes.OCI.RuntimeSpec
    requirements:
      - oci_runtime:
          capability: kubetos.capabilities.OCI.Runtime
          relationship: kubetos.relationships.OCI.Plugin
          occurrences: [ 1, UNBOUNDED ]
      - cni:
          capability: kubetos.capabilities.CNI
          relationship: tosca.relationships.DependsOn

  kubetos.nodes.CRI-O:
    derived_from: kubetos.nodes.CRI
    properties:
      component_version:
        type: version
        default: "1.21"

  kubetos.nodes.Crictl:
    derived_from: tosca.nodes.SoftwareComponent
    properties:
      component_version:
        type: version
        default: 1.21.0
    requirements:
      - cri_runtime:
          capability: kubetos.capabilities.CRI
          relationship: tosca.relationships.ConnectsTo
