tosca_definitions_version: tosca_simple_yaml_1_3

metadata:
  template_name: "kubetos"
  template_author: "shishqa"
  template_version: "1.0"

imports:
  - profiles/etcd/main.yaml
  - profiles/cri/main.yaml
  - profiles/cni/main.yaml
  - profiles/kubernetes/main.yaml

topology_template:

  inputs:

    kubernetes_version:
      type: version
      default: 1.21.0

    cluster_name:
      type: string
      default: kubernetes-cluster

    cluster_cidr:
      type: string
      default: 10.233.0.0/16

    service_cidr:
      type: string
      default: 10.32.0.0/16

    dns_ip:
      type: string
      default: 10.32.0.3

  node_templates:

    controller_manager:
      type: kubetos.nodes.Kube.ControllerManager
      properties:
        component_version: { get_input: [ kubernetes_version ] }
        cluster_cidr: { get_input: [ cluster_cidr ] }
        service_cidr: { get_input: [ service_cidr ] }
      requirements:
        - host: kube_node
        - ca: kubernetes_ca_hosted
        - service_account_cert: service_account_cert_hosted
        - kubeconfig: controller_manager_kubeconfig_hosted

    controller_manager_user:
      type: kubetos.nodes.Kubernetes.User
      capabilities:
        user:
          properties:
            name: default-controller-manager
      requirements:
        - cert: kube_controller_manager_cert

    controller_manager_kubeconfig_hosted:
      type: kubetos.nodes.Artifact.Kubeconfig
      properties:
        path: /etc/kubernetes/controller-manager.conf
      requirements:
        - kubeconfig: controller_manager_kubeconfig
        - host: kube_node

    controller_manager_kubeconfig:
      type: kubetos.nodes.Kubeconfig
      requirements:
        - cluster: kube_local_cluster
        - user: controller_manager_user

    kube_controller_manager_cert:
      type: kubetos.nodes.Certificate
      properties:
        common_name: system:kube-controller-manager
        organisation: system:kube-controller-manager
      requirements:
        - ca: kubernetes_ca

    service_account_cert_hosted:
      type: kubetos.nodes.Artifact.Certificate
      properties:
        cert_path: /etc/kubernetes/pki/sa.crt
        key_path: /etc/kubernetes/pki/sa.key
      requirements:
        - cert: service_account_cert
        - host: kube_node

    service_account_cert:
      type: kubetos.nodes.Certificate
      properties:
        common_name: service-accounts
        organisation: kubernetes
      requirements:
        - ca: kubernetes_ca

    kubernetes_ca_hosted:
      type: kubetos.nodes.Artifact.Certificate
      properties:
        cert_path: /etc/kubernetes/pki/ca.crt
        key_path: /etc/kubernetes/pki/ca.pem
      requirements:
        - cert: kubernetes_ca
        - host: kube_node

    kubernetes_ca:
      type: kubetos.nodes.CertificateAuthority
      properties:
        common_name: kubernetes-ca
        organisation: kubernetes

    kube_local_cluster:
      type: kubetos.nodes.Kubernetes.Cluster
      capabilities:
        cluster:
          properties:
            name: test-cluster
      attributes:
        apiserver_address: 127.0.0.1
      requirements:
        - ca: kubernetes_ca

    kube_node:
      type: kubetos.nodes.Abstract.KubeNode
      directives:
        - select

  substitution_mappings:
    node_type: kubetos.nodes.Abstract.Kube.ControllerManager
    # capabilities:
    #   host: [ kube_node, host ]
    #   os: [ kube_node, os ]
    #   endpoint: [ kube_node, endpoint ]
    #   scalable: [ kube_node, scalable ]
    #   binding: [ kube_node, binding ]
    properties:
      component_version: [ kubernetes_version ]
      cluster_cidr: [ cluster_cidr ]
      service_cidr: [ service_cidr ]
    # attributes:
    #   private_address: [ kube_node, private_address ]
    #   public_address: [ kube_node, public_address ]
    #   networks: [ kube_node, networks ]
    #   ports: [ kube_node, ports ]
    #   tosca_name: [ kube_node, tosca_name ]