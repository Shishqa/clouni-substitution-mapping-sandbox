tosca_definitions_version: tosca_simple_yaml_1_3

metadata:
  template_name: "kubetos-crio"
  template_author: "shishqa"
  template_version: "1.0"

imports:
  - profiles/cri/main.yaml
  - profiles/cni/main.yaml

topology_template:

  inputs:

    kubernetes_version:
      type: version
      default: 1.21.0

    cluster_name:
      type: string
      default: kubernetes-cluster

    pod_cidr:
      type: string
      default: 10.233.0.0/16

    service_cidr:
      type: string
      default: 10.32.0.0/16

    dns_ip:
      type: string
      default: 10.32.0.3

  node_templates:

    crictl:
      type: kubetos.nodes.Crictl
      properties:
        component_version: { get_input: [ kubernetes_version ] }
      requirements:
        - host: compute
        - cri_runtime: crio

    crio:
      type: kubetos.nodes.CRI-O
      capabilities:
        cri:
          properties:
            url_path: /var/run/crio/crio.sock
      requirements:
        - host: compute
        - oci_runtime: runc
        - oci_runtime: kata
        - cni: cni

    runc:
      type: kubetos.nodes.Runc
      capabilities:
        oci:
          properties:
            spec:
              name: runc
              path: /usr/sbin/runc
              root: /run/runc
      requirements:
        - host: compute

    kata:
      type: kubetos.nodes.Kata
      capabilities:
        oci:
          properties:
            spec:
              name: kata
              path: /opt/kata/bin/kata-runtime
              root: /run/kata-containers
      requirements:
        - host: compute

    cni:
      type: kubetos.nodes.Abstract.CNI
      directives:
        - substitute
      requirements:
        - host: compute
      
    compute:
      type: tosca.nodes.Compute
      directives:
        - select

  substitution_mappings:
    node_type: kubetos.nodes.Abstract.CRI
    capabilities:
      cri: [ crio, cri ]
    attributes:
      runtimes: [ crio, runtimes ]