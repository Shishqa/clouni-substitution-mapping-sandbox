tosca_definitions_version: tosca_simple_yaml_1_3

metadata:
  template_name: "kubetos"
  template_author: "shishqa"
  template_version: "1.0"

imports:
  - profiles/etcd/main.yaml
  - profiles/cri/main.yaml
  - profiles/cni/main.yaml
  - profiles/kubernetes/main.yaml

topology_template:

  inputs:

    kubernetes_version:
      type: version
      default: 1.21.0

    config_path:
      type: string
      default: /etc/kubernetes/kube-scheduler.yaml

  node_templates:

    scheduler:
      type: kubetos.nodes.Kube.Scheduler
      properties:
        component_version: { get_input: [ kubernetes_version ] }
        config_path: { get_input: [ config_path ] }
      requirements:
        - host: kube_node
        - kubeconfig: scheduler_kubeconfig_hosted

    scheduler_user:
      type: kubetos.nodes.Kubernetes.User
      capabilities:
        user:
          properties:
            name: default-scheduler
      requirements:
        - cert: kube_scheduler_cert

    scheduler_kubeconfig_hosted:
      type: kubetos.nodes.Artifact.Kubeconfig
      properties:
        path: /etc/kubernetes/scheduler.conf
      requirements:
        - kubeconfig: scheduler_kubeconfig
        - host: kube_node

    scheduler_kubeconfig:
      type: kubetos.nodes.Kubeconfig
      requirements:
        - cluster: kube_local_cluster
        - user: scheduler_user

    kube_scheduler_cert:
      type: kubetos.nodes.Certificate
      properties:
        common_name: system:kube-scheduler
        organisation: system:kube-scheduler
      requirements:
        - ca: kubernetes_ca

    kubernetes_ca:
      type: kubetos.nodes.CertificateAuthority
      properties:
        common_name: kubernetes-ca
        organisation: kubernetes

    kube_local_cluster:
      type: kubetos.nodes.Kubernetes.Cluster
      capabilities:
        cluster:
          properties:
            name: test-cluster
      attributes:
        apiserver_address: 127.0.0.1
      requirements:
        - ca: kubernetes_ca

    kube_node:
      type: kubetos.nodes.Abstract.KubeNode
      directives:
        - select

  substitution_mappings:
    node_type: kubetos.nodes.Abstract.Kube.Scheduler
    # capabilities:
    #   host: [ kube_node, host ]
    #   os: [ kube_node, os ]
    #   endpoint: [ kube_node, endpoint ]
    #   scalable: [ kube_node, scalable ]
    #   binding: [ kube_node, binding ]
    properties:
      component_version: [ kubernetes_version ]
      config_path: [ config_path ]
    # attributes:
    #   private_address: [ kube_node, private_address ]
    #   public_address: [ kube_node, public_address ]
    #   networks: [ kube_node, networks ]
    #   ports: [ kube_node, ports ]
    #   tosca_name: [ kube_node, tosca_name ]
    